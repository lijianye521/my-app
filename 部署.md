# Next.js ä¼ä¸šè‚¡ç¥¨å·¥å…·ç®±éƒ¨ç½²æ–‡æ¡£

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°
ä¼ä¸šè‚¡ç¥¨å·¥å…·ç®±æ˜¯ä¸€ä¸ªåŸºäº Next.js çš„ç®¡ç†å¹³å°ï¼Œé›†æˆäº†ç”¨æˆ·è®¤è¯ã€å¹³å°æœåŠ¡ç®¡ç†ã€æ•°æ®åº“è¿ç§»ç­‰åŠŸèƒ½ã€‚

## ğŸ“¦ ç¯å¢ƒè¦æ±‚
- Git â‰¥ 2.x
- Node.js 20ï¼ˆæ¨èä½¿ç”¨ nvmï¼‰
- npm â‰¥ 9.x æˆ– yarn â‰¥ 1.x
- MySQL â‰¥ 5.7 æˆ– MariaDB â‰¥ 10.3
- PM2ï¼ˆç”Ÿäº§ç¯å¢ƒè¿›ç¨‹ç®¡ç†ï¼‰
- curl æˆ– wget
- ç½‘ç»œè¿æ¥æ­£å¸¸

## ğŸ”§ æ­¥éª¤ä¸€ï¼šå®‰è£… Node.js 20ï¼ˆæ¨èä½¿ç”¨ nvmï¼‰
```bash
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
source ~/.bashrc
nvm install 20
nvm use 20
nvm alias default 20
```

## ğŸ§¬ æ­¥éª¤äºŒï¼šå®‰è£… Gitï¼ˆå¦‚æœªå®‰è£…ï¼‰
```bash
sudo apt update
sudo apt install git -y
```

## ğŸ—„ï¸ æ­¥éª¤ä¸‰ï¼šé…ç½®æ•°æ®åº“
ç¡®ä¿ MySQL æœåŠ¡æ­£åœ¨è¿è¡Œï¼Œå¹¶åˆ›å»ºæ•°æ®åº“ï¼š
```sql
CREATE DATABASE stock_lab CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'root2'@'localhost' IDENTIFIED BY '123456';
GRANT ALL PRIVILEGES ON stock_lab.* TO 'root2'@'localhost';
FLUSH PRIVILEGES;
```

## ğŸ“¥ æ­¥éª¤å››ï¼šé¡¹ç›®éƒ¨ç½²æµç¨‹

### 4.1 åœæ­¢ç°æœ‰æœåŠ¡ï¼ˆå¦‚æœä¹‹å‰éƒ¨ç½²è¿‡ï¼‰
```bash
# åœæ­¢å¹¶åˆ é™¤ç°æœ‰çš„PM2è¿›ç¨‹
pm2 stop my-app
pm2 delete my-app
pm2 save
```

### 4.2 æ›´æ–°é¡¹ç›®ä»£ç 
```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd /path/to/your/project

# æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main

# æˆ–è€…é‡æ–°å…‹éš†ï¼ˆå¦‚æœæ˜¯é¦–æ¬¡éƒ¨ç½²ï¼‰
# git clone https://github.com/lijianye521/my-app.git
# cd my-app
```

### 4.3 å®‰è£…/æ›´æ–°ä¾èµ–
```bash
# æ¸…ç†æ—§çš„node_moduleså’Œé”æ–‡ä»¶ï¼ˆå¯é€‰ï¼Œè§£å†³ä¾èµ–å†²çªï¼‰
rm -rf node_modules package-lock.json

# å®‰è£…ä¾èµ–
npm install

# æˆ–è€…ä½¿ç”¨ yarn
# yarn install
```

### 4.4 é…ç½®ç¯å¢ƒå˜é‡
```bash
# åˆ›å»ºæˆ–æ›´æ–°ç¯å¢ƒé…ç½®æ–‡ä»¶
cp .env.example .env.local  # å¦‚æœæœ‰ç¤ºä¾‹æ–‡ä»¶
# æˆ–è€…ç›´æ¥åˆ›å»º
nano .env.local
```

ç¤ºä¾‹ `.env.local` å†…å®¹ï¼š
```env
# æ•°æ®åº“é…ç½®
DB_HOST=localhost
DB_PORT=3306
DB_USERNAME=root2
DB_PASSWORD=123456
DB_DATABASE=stock_lab

# NextAuth é…ç½®
NEXTAUTH_URL=http://localhost:3000
NEXTAUTH_SECRET=your-secret-key-here

# å…¶ä»–é…ç½®
NEXT_PUBLIC_API_URL=http://localhost:3000/api
```

### 4.5 æ•°æ®åº“åˆå§‹åŒ–å’Œè¿ç§»
```bash
# é¦–æ¬¡éƒ¨ç½²ï¼šè¿è¡Œåˆå§‹åŒ–è„šæœ¬
mysql -u root2 -p123456 stock_lab < database/init.sql

# æ£€æŸ¥è¿ç§»çŠ¶æ€
npx sequelize-cli db:migrate:status

# è¿è¡Œæ‰€æœ‰å¾…æ‰§è¡Œçš„è¿ç§»
npx sequelize-cli db:migrate

# æˆ–è€…ä½¿ç”¨é¡¹ç›®è‡ªå¸¦çš„è¿ç§»å·¥å…·
node database/migrate.js status
node database/migrate.js up
```

### 4.6 æ„å»ºç”Ÿäº§ç‰ˆæœ¬
```bash
# æ„å»ºé¡¹ç›®
npm run build

# æ£€æŸ¥æ„å»ºæ˜¯å¦æˆåŠŸ
ls -la .next/
```

## ğŸš€ æ­¥éª¤äº”ï¼šç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

### 5.1 å®‰è£… PM2ï¼ˆå¦‚æœªå®‰è£…ï¼‰
```bash
npm install -g pm2
```

### 5.2 å¯åŠ¨æœåŠ¡
```bash
# æ–¹å¼1ï¼šç›´æ¥å¯åŠ¨
pm2 start npm --name "stock-toolbox" -- start

# æ–¹å¼2ï¼šä½¿ç”¨é…ç½®æ–‡ä»¶ï¼ˆæ¨èï¼‰
# åˆ›å»º ecosystem.config.js
cat > ecosystem.config.js << EOF
module.exports = {
  apps: [{
    name: 'stock-toolbox',
    script: 'npm',
    args: 'start',
    cwd: '$(pwd)',
    instances: 1,
    autorestart: true,
    watch: false,
    max_memory_restart: '1G',
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    }
  }]
}
EOF

# ä½¿ç”¨é…ç½®æ–‡ä»¶å¯åŠ¨
pm2 start ecosystem.config.js
```

### 5.3 ä¿å­˜ PM2 é…ç½®
```bash
# ä¿å­˜å½“å‰è¿›ç¨‹åˆ—è¡¨
pm2 save

# è®¾ç½®å¼€æœºè‡ªå¯
pm2 startup
# æŒ‰ç…§æç¤ºæ‰§è¡Œè¿”å›çš„å‘½ä»¤
```

## ğŸ“Š æ­¥éª¤å…­ï¼šéªŒè¯éƒ¨ç½²

### 6.1 æ£€æŸ¥æœåŠ¡çŠ¶æ€
```bash
# æŸ¥çœ‹PM2è¿›ç¨‹çŠ¶æ€
pm2 status

# æŸ¥çœ‹æ—¥å¿—
pm2 logs stock-toolbox

# æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
pm2 info stock-toolbox
```

### 6.2 æµ‹è¯•åº”ç”¨
```bash
# æµ‹è¯•æœ¬åœ°è®¿é—®
curl http://localhost:3000

# æ£€æŸ¥æ•°æ®åº“è¿æ¥
curl http://localhost:3000/api/db-status
```

æµè§ˆå™¨è®¿é—®ï¼šhttp://localhost:3000

## ğŸ› ï¸ å¸¸ç”¨ç®¡ç†å‘½ä»¤

### PM2 ç®¡ç†
```bash
# æŸ¥çœ‹æ‰€æœ‰è¿›ç¨‹
pm2 list

# é‡å¯åº”ç”¨
pm2 restart stock-toolbox

# åœæ­¢åº”ç”¨
pm2 stop stock-toolbox

# åˆ é™¤åº”ç”¨
pm2 delete stock-toolbox

# ç›‘æ§
pm2 monit

# æŸ¥çœ‹æ—¥å¿—
pm2 logs stock-toolbox --lines 100
```

### æ•°æ®åº“è¿ç§»ç®¡ç†
```bash
# æŸ¥çœ‹è¿ç§»çŠ¶æ€
node database/migrate.js status

# åº”ç”¨è¿ç§»
node database/migrate.js up

# å›æ»šè¿ç§»
node database/migrate.js down

# é‡ç½®æ‰€æœ‰è¿ç§»
node database/migrate.js reset
```

### ä»£ç æ›´æ–°æµç¨‹
```bash
# 1. åœæ­¢æœåŠ¡
pm2 stop stock-toolbox

# 2. æ›´æ–°ä»£ç 
git pull origin main

# 3. å®‰è£…æ–°ä¾èµ–
npm install

# 4. è¿è¡Œæ•°æ®åº“è¿ç§»
node database/migrate.js up

# 5. é‡æ–°æ„å»º
npm run build

# 6. é‡å¯æœåŠ¡
pm2 restart stock-toolbox
```

## ğŸ”’ æƒé™è¯´æ˜ï¼ˆå¦‚é‡æƒé™é—®é¢˜ï¼‰
```bash
# è®¾ç½®é¡¹ç›®æ–‡ä»¶æƒé™
chmod -R 755 .
chmod +x database/migrate.js

# å¦‚æœéœ€è¦ï¼Œè®¾ç½®Node.jsæƒé™
sudo chown -R $USER:$GROUP ~/.npm
sudo chown -R $USER:$GROUP ~/.nvm
```

## ğŸ§ª å¼€å‘ç¯å¢ƒå‘½ä»¤
```bash
# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
npm run dev

# ä»£ç æ£€æŸ¥
npm run lint

# è¿è¡Œæµ‹è¯•
npm test

# ç±»å‹æ£€æŸ¥
npm run type-check
```

## ğŸ“ é¡¹ç›®ç»“æ„
```
stock-toolbox/
â”œâ”€â”€ app/                    # Next.js 13+ App Router
â”‚   â”œâ”€â”€ api/               # API è·¯ç”±
â”‚   â”œâ”€â”€ pages/             # é¡µé¢ç»„ä»¶
â”‚   â””â”€â”€ globals.css        # å…¨å±€æ ·å¼
â”œâ”€â”€ components/            # React ç»„ä»¶
â”‚   â””â”€â”€ ui/               # UI ç»„ä»¶åº“
â”œâ”€â”€ config/               # é…ç½®æ–‡ä»¶
â”‚   â””â”€â”€ config.json       # æ•°æ®åº“é…ç½®
â”œâ”€â”€ database/             # æ•°æ®åº“ç›¸å…³
â”‚   â”œâ”€â”€ init.sql          # åˆå§‹åŒ–è„šæœ¬
â”‚   â””â”€â”€ migrate.js        # è¿ç§»å·¥å…·
â”œâ”€â”€ lib/                  # å·¥å…·åº“
â”œâ”€â”€ migrations/           # æ•°æ®åº“è¿ç§»æ–‡ä»¶
â”œâ”€â”€ models/              # æ•°æ®æ¨¡å‹
â”œâ”€â”€ public/              # é™æ€èµ„æº
â”œâ”€â”€ .env.local           # ç¯å¢ƒå˜é‡
â”œâ”€â”€ .sequelizerc         # Sequelize é…ç½®
â”œâ”€â”€ ecosystem.config.js  # PM2 é…ç½®
â”œâ”€â”€ next.config.ts       # Next.js é…ç½®
â”œâ”€â”€ package.json         # é¡¹ç›®ä¾èµ–
â””â”€â”€ tsconfig.json        # TypeScript é…ç½®
```

## ğŸ” æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜
1. **ç«¯å£è¢«å ç”¨**
   ```bash
   sudo lsof -i :3000
   sudo kill -9 PID
   ```

2. **æ•°æ®åº“è¿æ¥å¤±è´¥**
   - æ£€æŸ¥æ•°æ®åº“æœåŠ¡çŠ¶æ€
   - éªŒè¯é…ç½®æ–‡ä»¶ä¸­çš„æ•°æ®åº“ä¿¡æ¯
   - ç¡®è®¤ç”¨æˆ·æƒé™

3. **è¿ç§»å¤±è´¥**
   ```bash
   # æ£€æŸ¥æ•°æ®åº“è¡¨ç»“æ„
   mysql -u root2 -p123456 stock_lab -e "SHOW TABLES;"
   
   # é‡ç½®è¿ç§»ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
   node database/migrate.js reset
   ```

4. **æ„å»ºå¤±è´¥**
   ```bash
   # æ¸…ç†ç¼“å­˜
   rm -rf .next
   npm run build
   ```

## ğŸ“ å‚è€ƒé“¾æ¥
- [Next.js å®˜æ–¹æ–‡æ¡£](https://nextjs.org/docs)
- [Node.js å®‰è£…æŒ‡å— (nvm)](https://github.com/nvm-sh/nvm)
- [PM2 æ–‡æ¡£](https://pm2.keymetrics.io/)
- [Sequelize CLI æ–‡æ¡£](https://sequelize.org/docs/v6/other-topics/migrations/)
- [MySQL å®˜æ–¹æ–‡æ¡£](https://dev.mysql.com/doc/)

## ğŸ“ æ›´æ–°æ—¥å¿—
- 2024-01-XX: æ·»åŠ æ•°æ®åº“è¿ç§»æ”¯æŒ
- 2024-01-XX: é›†æˆPM2è¿›ç¨‹ç®¡ç†
- 2024-01-XX: å®Œå–„éƒ¨ç½²æµç¨‹æ–‡æ¡£
