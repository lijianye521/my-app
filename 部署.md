# Next.js 企业股票工具箱部署文档

## 📋 项目概述
企业股票工具箱是一个基于 Next.js 的管理平台，集成了用户认证、平台服务管理、数据库迁移等功能。

## 📦 环境要求
- Git ≥ 2.x
- Node.js 20（推荐使用 nvm）
- npm ≥ 9.x 或 yarn ≥ 1.x
- MySQL ≥ 5.7 或 MariaDB ≥ 10.3
- PM2（生产环境进程管理）
- curl 或 wget
- 网络连接正常

## 🔧 步骤一：安装 Node.js 20（推荐使用 nvm）
```bash
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
source ~/.bashrc
nvm install 20
nvm use 20
nvm alias default 20
```

## 🧬 步骤二：安装 Git（如未安装）
```bash
sudo apt update
sudo apt install git -y
```

## 🗄️ 步骤三：配置数据库
确保 MySQL 服务正在运行，并创建数据库：
```sql
CREATE DATABASE stock_lab CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'root2'@'localhost' IDENTIFIED BY '123456';
GRANT ALL PRIVILEGES ON stock_lab.* TO 'root2'@'localhost';
FLUSH PRIVILEGES;
```

## 📥 步骤四：项目部署流程

### 4.1 停止现有服务（如果之前部署过）
```bash
# 停止并删除现有的PM2进程
pm2 stop my-app
pm2 delete my-app
pm2 save
```

### 4.2 更新项目代码
```bash
# 进入项目目录
cd /path/to/your/project

# 拉取最新代码
git pull origin main

# 或者重新克隆（如果是首次部署）
# git clone https://github.com/lijianye521/my-app.git
# cd my-app
```

### 4.3 安装/更新依赖
```bash
# 清理旧的node_modules和锁文件（可选，解决依赖冲突）
rm -rf node_modules package-lock.json

# 安装依赖
npm install

# 或者使用 yarn
# yarn install
```

### 4.4 配置环境变量
```bash
# 创建或更新环境配置文件
cp .env.example .env.local  # 如果有示例文件
# 或者直接创建
nano .env.local
```

示例 `.env.local` 内容：
```env
# 数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_USERNAME=root2
DB_PASSWORD=123456
DB_DATABASE=stock_lab

# NextAuth 配置
NEXTAUTH_URL=http://localhost:3000
NEXTAUTH_SECRET=your-secret-key-here

# 其他配置
NEXT_PUBLIC_API_URL=http://localhost:3000/api
```

### 4.5 数据库初始化和迁移
```bash
# 首次部署：运行初始化脚本
mysql -u root2 -p123456 stock_lab < database/init.sql

# 检查迁移状态
npx sequelize-cli db:migrate:status

# 运行所有待执行的迁移
npx sequelize-cli db:migrate

# 或者使用项目自带的迁移工具
node database/migrate.js status
node database/migrate.js up
```

### 4.6 构建生产版本
```bash
# 构建项目
npm run build

# 检查构建是否成功
ls -la .next/
```

## 🚀 步骤五：生产环境部署

### 5.1 安装 PM2（如未安装）
```bash
npm install -g pm2
```

### 5.2 启动服务
```bash
# 方式1：直接启动
pm2 start npm --name "stock-toolbox" -- start

# 方式2：使用配置文件（推荐）
# 创建 ecosystem.config.js
cat > ecosystem.config.js << EOF
module.exports = {
  apps: [{
    name: 'stock-toolbox',
    script: 'npm',
    args: 'start',
    cwd: '$(pwd)',
    instances: 1,
    autorestart: true,
    watch: false,
    max_memory_restart: '1G',
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    }
  }]
}
EOF

# 使用配置文件启动
pm2 start ecosystem.config.js
```

### 5.3 保存 PM2 配置
```bash
# 保存当前进程列表
pm2 save

# 设置开机自启
pm2 startup
# 按照提示执行返回的命令
```

## 📊 步骤六：验证部署

### 6.1 检查服务状态
```bash
# 查看PM2进程状态
pm2 status

# 查看日志
pm2 logs stock-toolbox

# 查看详细信息
pm2 info stock-toolbox
```

### 6.2 测试应用
```bash
# 测试本地访问
curl http://localhost:3000

# 检查数据库连接
curl http://localhost:3000/api/db-status
```

浏览器访问：http://localhost:3000

## 🛠️ 常用管理命令

### PM2 管理
```bash
# 查看所有进程
pm2 list

# 重启应用
pm2 restart stock-toolbox

# 停止应用
pm2 stop stock-toolbox

# 删除应用
pm2 delete stock-toolbox

# 监控
pm2 monit

# 查看日志
pm2 logs stock-toolbox --lines 100
```

### 数据库迁移管理
```bash
# 查看迁移状态
node database/migrate.js status

# 应用迁移
node database/migrate.js up

# 回滚迁移
node database/migrate.js down

# 重置所有迁移
node database/migrate.js reset
```

### 代码更新流程
```bash
# 1. 停止服务
pm2 stop stock-toolbox

# 2. 更新代码
git pull origin main

# 3. 安装新依赖
npm install

# 4. 运行数据库迁移
node database/migrate.js up

# 5. 重新构建
npm run build

# 6. 重启服务
pm2 restart stock-toolbox
```

## 🔒 权限说明（如遇权限问题）
```bash
# 设置项目文件权限
chmod -R 755 .
chmod +x database/migrate.js

# 如果需要，设置Node.js权限
sudo chown -R $USER:$GROUP ~/.npm
sudo chown -R $USER:$GROUP ~/.nvm
```

## 🧪 开发环境命令
```bash
# 启动开发服务器
npm run dev

# 代码检查
npm run lint

# 运行测试
npm test

# 类型检查
npm run type-check
```

## 📁 项目结构
```
stock-toolbox/
├── app/                    # Next.js 13+ App Router
│   ├── api/               # API 路由
│   ├── pages/             # 页面组件
│   └── globals.css        # 全局样式
├── components/            # React 组件
│   └── ui/               # UI 组件库
├── config/               # 配置文件
│   └── config.json       # 数据库配置
├── database/             # 数据库相关
│   ├── init.sql          # 初始化脚本
│   └── migrate.js        # 迁移工具
├── lib/                  # 工具库
├── migrations/           # 数据库迁移文件
├── models/              # 数据模型
├── public/              # 静态资源
├── .env.local           # 环境变量
├── .sequelizerc         # Sequelize 配置
├── ecosystem.config.js  # PM2 配置
├── next.config.ts       # Next.js 配置
├── package.json         # 项目依赖
└── tsconfig.json        # TypeScript 配置
```

## 🔍 故障排除

### 常见问题
1. **端口被占用**
   ```bash
   sudo lsof -i :3000
   sudo kill -9 PID
   ```

2. **数据库连接失败**
   - 检查数据库服务状态
   - 验证配置文件中的数据库信息
   - 确认用户权限

3. **迁移失败**
   ```bash
   # 检查数据库表结构
   mysql -u root2 -p123456 stock_lab -e "SHOW TABLES;"
   
   # 重置迁移（谨慎使用）
   node database/migrate.js reset
   ```

4. **构建失败**
   ```bash
   # 清理缓存
   rm -rf .next
   npm run build
   ```

## 📎 参考链接
- [Next.js 官方文档](https://nextjs.org/docs)
- [Node.js 安装指南 (nvm)](https://github.com/nvm-sh/nvm)
- [PM2 文档](https://pm2.keymetrics.io/)
- [Sequelize CLI 文档](https://sequelize.org/docs/v6/other-topics/migrations/)
- [MySQL 官方文档](https://dev.mysql.com/doc/)

## 📝 更新日志
- 2024-01-XX: 添加数据库迁移支持
- 2024-01-XX: 集成PM2进程管理
- 2024-01-XX: 完善部署流程文档
